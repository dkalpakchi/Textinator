{% extends "layout.html" %}

{% block custom_styles %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
{% endblock %}

{% block custom_scripts %}
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="{{ static('scripts/data_explorer.js') }}"></script>
{% endblock %}

{% block content %}
<div class="explorer">
  <div class="container is-fluid">
    <a href="{{ url('projects:detail', kwargs={'pk': project.pk}) }}" class="button is-info">Back to the project</a>
    <a href="{{ url('projects:data_exporter', kwargs={'proj': project.pk}) }}" class="button is-success" download>Export as JSON</a>
    <a href="{{ url('projects:time_report', kwargs={'proj': project.pk}) }}" class="button is-warning">Generate a PDF time report</a>
    <div class="is-pulled-right">In total: {{ total_datapoints }} {% if labeled_inputs %}input(s){% else %}relation(s){% endif %}, {{flagged_datapoints}} flagged datapoint(s) </div>
  </div>

  <script type="text/javascript" src="{{ static('js/highcharts/highcharts.js') }}"></script>
  {% if user.is_superuser %}
    <div class="container columns">
      <div class="column">
        <div id="labelLengthsChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:label_lengths_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#labelLengthsChart").highcharts(data);
          });
        </script>
      </div>
      <div class="column">
        <div id="userTimingChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:user_timing_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#userTimingChart").highcharts(data);
          });
        </script>
      </div>
    </div>
    <div class="container columns">
      <div class="column">
        <div id="userProgressChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:user_progress_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#userProgressChart").highcharts(data);
          });
        </script>
      </div>
      <div class="column">
        <div id="datasourceSizeChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:datasource_size_chart", kwargs={"pk": project.pk}) }}', function(data) {
            data['series'][0]['showInLegend'] = false;
            $("#datasourceSizeChart").highcharts(data);
          });
        </script>
      </div>
    </div>
  {% endif %}

  <div class="container is-fluid">
    {% for input, labels in labeled_inputs %}
      <div class="datapoint">
        <h4 class='title is-4'>
          {{input.content}} ({{input.id}})
          <div class="subtitle is-6">Created by <i>{{labels[0].user}}</i> on {{input.dt_created}}</div>
        </h4>
        <section id="item-context-{{loop.index}}">
          <h3>Context ({{input.context.id}})</h3>
          <div>
            {{input.context.content}}
          </div>
        </section>
        <ul>
          {% for label in labels %}
            <li {% if label.undone %}class="red"{% endif %}>
              {% if label.marker.short == 'COR' %}
                <b>{{label.text}}</b>
                {% if label.comment %}
                  <span><b>--> {{label.comment}}</b></span>
                {% endif %}
              {% else %}
                {{label.text}}
                {% if label.comment %}
                  <span>--> {{label.comment}}</span>
                {% endif %}
              {% endif %}

              <span>({{label.user}}, {{label.pk}})</span>
            </li>
          {% endfor %}
        </ul>
        {% if user.is_superuser %}
          <form method="POST" action="{{ url('projects:async_delete_input', kwargs={'inp': input.pk, 'proj': project.pk}) }}" id="deleteForm">
            {{csrf_input}}
            <div class="control">
              <button class="ui button is-danger">
                <span class="icon"><i class="fas fa-trash-alt"></i></span>
                <span>Delete</span>
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    {% endfor %}

    {% for context, rels in relations %}
      <div class="datapoint relation">
        <h4 class='title is-5'>
          {{context.content}} ({{context.id}})
          <div class="subtitle is-6">Created by <i>{{rels[0][0].user}}</i> on {{context.dt_created}}</div>
        </h4>
        <ul>
          {% for fst, snd in rels %}
            <li>
              {{fst.text}} ==> {{snd.text}}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}

    {% if paginator.num_pages > 1 %}
      <nav class="pagination" role="navigation" aria-label="pagination">
        <ul class="pagination-list">
          {% for p in paginator.page_range %}
            <li>
              {% if p == current_page %}
              <a class="pagination-link is-current" aria-label="Page {{p}}">{{p}}</a>
              {% else %}
              <a class="pagination-link" href="{{ url('projects:data_explorer', kwargs={'proj': project.id}) }}?page={{p}}" aria-label="Goto page {{p}}">{{p}}</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>
{% endblock %}
