{% extends "layout.html" %}

{% block custom_styles %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="{% sass_src 'styles/data-explorer.scss' %}">
{% endblock %}

{% block custom_scripts %}
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="{{ static('scripts/bulma-collapsible.min.js') }}"></script>
<script type="text/javascript" src="{{ static('scripts/data_explorer.js') }}"></script>
{% endblock %}

{% block content %}
<div class="explorer">
  <div class="container is-fluid">
    <div>
      <a href="{{ url('projects:detail', kwargs={'pk': project.pk}) }}" class="button is-info">Back to the project</a>
      <a data-url="{{ url('projects:data_exporter', kwargs={'proj': project.pk}) }}" class="button is-success" download>Export as JSON</a>
      <a data-url="{{ url('projects:data_exporter_generic', kwargs={'proj': project.pk}) }}" class="button is-success" download>Export as JSON (generic)</a>
      {% if project.author == user or project.shared_with(user) %}
        <a href="{{ url('projects:time_report', kwargs={'proj': project.pk}) }}" class="button is-warning">Generate a PDF time report</a>
      {% endif %}
    </div>
    <div class="mt-5">
      In total: {{total_batches}} batches, {{ total_labels }} label(s), {{ total_relations }} relation(s), {{total_inputs}} input(s), {{flagged_datapoints.count()}} flagged text(s)
    </div>
  </div>

  <script type="text/javascript" src="{{ static('highcharts/highcharts.js') }}"></script>
  <script type="text/javascript" src="{{ static('highcharts/modules/no-data-to-display.js') }}"></script>
  {% if project.author == user or project.shared_with(user) %}
    <div class="container columns">
      <div class="column">
        <div id="labelLengthsChart" width="300" height="150"></div>
        <script type="text/javascript">
          Highcharts.setOptions({lang: {noData: "Not enough data to display"}})
          $.get('{{ url("projects:label_lengths_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#labelLengthsChart").highcharts(data);
          });
        </script>
      </div>
      <div class="column">
        <div id="userTimingChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:user_timing_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#userTimingChart").highcharts(data);
          });
        </script>
      </div>
    </div>
    <div class="container columns">
      <div class="column">
        <div id="userProgressChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:user_progress_chart", kwargs={"pk": project.pk}) }}', function(data) {
            $("#userProgressChart").highcharts(data);
          });
        </script>
      </div>
      <div class="column">
        <div id="datasourceSizeChart" width="300" height="150"></div>
        <script type="text/javascript">
          $.get('{{ url("projects:datasource_size_chart", kwargs={"pk": project.pk}) }}', function(data) {
            data['series'][0]['showInLegend'] = false;
            $("#datasourceSizeChart").highcharts(data);
          });
        </script>
      </div>
    </div>
  {% endif %}

  {% if flagged_datapoints %}
    <div class="container is-fluid mb-4">
      <article id="flaggedCollapse" class="message is-danger">
        <div class="message-header">
          <p>
            <span class="icon is-small mr-2">
              <i class="fas fa-flag"></i>
            </span>
            Flagged datapoints
          </p>
        </div>
        <div class="message-body">
          <table class="table is-fullwidth">
            <thead>
              <tr>
                <th>User</th>
                <th>Comment</th>
                <th>Text sample</th>
              </tr>
            </thead>
            <tbody>
              {% for flagged in flagged_datapoints %}
                <tr>
                  <td>{{ flagged.user.username }}</td>
                  <td>{{ flagged.flags }}</td>
                  <td>
                    {% if flagged.datasource.get(flagged.datapoint) is none %}
                      NA
                    {% else %}
                      {{ flagged.datasource.get(flagged.datapoint)|truncate(100,True) }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}  
            </tbody>
          </table>
        </div>
      </article>
    </div>
  {% endif %}
</div>
{% endblock %}
